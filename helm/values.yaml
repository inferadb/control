# Default values for InferaDB Control Helm chart

# Image configuration
image:
  repository: inferadb-control
  pullPolicy: IfNotPresent
  tag: "" # Overrides the image tag (default is Chart appVersion)

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Replica configuration
replicaCount: 2

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automount: false

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  runAsGroup: 65532
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65532

# Service configuration
service:
  type: ClusterIP
  httpPort: 9090   # REST API
  annotations: {}
  sessionAffinity: None

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: control.inferadb.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: inferadb-control-tls
  #    hosts:
  #      - control.inferadb.local

# Resource limits
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# Horizontal Pod Autoscaling
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - inferadb-control
          topologyKey: kubernetes.io/hostname

# Topology spread constraints
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: inferadb-control

# =============================================================================
# InferaDB Control Configuration
# =============================================================================
# All config values map to INFERADB__CONTROL__ environment variables.
# See `inferadb-control --help` for the full list of options.

config:
  # HTTP bind address
  listen: "0.0.0.0:9090"

  # Logging
  logLevel: "info"
  logFormat: "json"

  # Frontend URL (for email verification and password reset links)
  frontendUrl: ""  # e.g., "https://app.inferadb.com"

  # Master key file path
  keyFile: "/data/master.key"

  # Storage backend: "memory" or "ledger"
  storage: "memory"

  # Ledger configuration (required when storage = "ledger")
  ledgerEndpoint: ""   # e.g., "http://ledger.inferadb:50051"
  ledgerClientId: ""   # e.g., "control-001"
  ledgerNamespaceId: "" # e.g., "1"
  ledgerVaultId: ""    # optional

  # Email (SMTP) â€” leave emailHost empty to disable email
  emailHost: ""
  emailPort: "587"
  emailUsername: ""
  # emailPassword: set via secrets.emailPassword
  emailFromAddress: "noreply@inferadb.com"
  emailFromName: "InferaDB"
  emailInsecure: "false"

# =============================================================================
# Service Discovery Configuration
# =============================================================================

discovery:
  # Discovery mode: "none", "kubernetes", "tailscale"
  mode: "kubernetes"

  # Cache TTL for discovered endpoints (in seconds)
  cacheTtl: 30

  # Engine service discovery (for cache invalidation webhooks)
  engine:
    # Kubernetes service name (when mode = kubernetes)
    serviceName: "inferadb-engine"
    namespace: "inferadb"
    port: 8080  # Engine HTTP port for webhooks
    # Label selector for pod discovery
    labelSelector: "app.kubernetes.io/name=inferadb-engine"

  # Tailscale multi-region configuration (when mode = tailscale)
  tailscale:
    enabled: false
    localCluster: "primary"
    remoteClusters: []
    # - name: "eu-west-1"
    #   tailscaleDomain: "eu-west-1.ts.net"
    #   serviceName: "inferadb-engine"
    #   port: 8080

    authKey:
      existingSecret: "tailscale-auth"
      key: "authkey"
      value: ""

    image:
      repository: tailscale/tailscale
      tag: "v1.56.1"
      pullPolicy: IfNotPresent

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    extraArgs: "--accept-routes"
    acceptDNS: false

# =============================================================================
# Secrets Configuration
# =============================================================================

secrets:
  # Ed25519 PEM key for control identity (auto-generated if absent)
  pem: ""

  # Email password (for SMTP authentication)
  emailPassword: ""

  # Additional custom secrets
  additional: {}

# External Secrets Operator integration
externalSecrets:
  enabled: false
  secretStoreRef:
    name: ""
    kind: SecretStore # or ClusterSecretStore
  refreshInterval: 1h
  data: []
    # - secretKey: INFERADB__CONTROL__PEM
    #   remoteRef:
    #     key: inferadb/prod/control
    #     property: pem
    # - secretKey: INFERADB__CONTROL__EMAIL_PASSWORD
    #   remoteRef:
    #     key: inferadb/prod/control
    #     property: emailPassword

# =============================================================================
# Health Checks
# =============================================================================

healthCheck:
  liveness:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3

  readiness:
    httpGet:
      path: /readyz
      port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3

  startup:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30

# Graceful shutdown
terminationGracePeriodSeconds: 30

# Init containers (e.g., wait for Ledger)
initContainers: []
  # - name: wait-for-ledger
  #   image: busybox:1.36
  #   command:
  #   - sh
  #   - -c
  #   - |
  #     until nc -z -v -w30 ledger.inferadb 50051; do
  #       sleep 5
  #     done

# Extra environment variables
extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"

# Extra volume mounts
extraVolumeMounts: []

# Extra volumes
extraVolumes: []

# ServiceMonitor for Prometheus Operator
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  honorLabels: true
  relabelings: []
  metricRelabelings: []

